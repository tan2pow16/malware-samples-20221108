# Malware Mishmash
It's healthy to have a variant of veggies in a meal, but malware mixing multiple languages isn't good for your devices.

## Intro
In the last few days, a couple of interesting samples landed in my malware feed. Other than using the extremely popular C#/NSIS packers in recent days, these files stood out as they came with a different wrapper. It turns out the files are mixing multiple techniques to avoid detection. Although one of the tools they use, AutoIt, is far from welcome to many antimalware vendors. The obfuscation methods seem to be made by novices in the cybercrime field and are quite interesting to look into.

The showcased samples can be found here:  
[`6cf46a7f8141a73e089096e01134ae4a0c32ace2e5883be0ff1792e6d9fe5869`](https://www.virustotal.com/gui/file/6cf46a7f8141a73e089096e01134ae4a0c32ace2e5883be0ff1792e6d9fe5869)  
[`f2c7a204dd011ce0e8466c7fdd0e62de4e5bd919c00846233e8dd7adca7c1888`](https://www.virustotal.com/gui/file/f2c7a204dd011ce0e8466c7fdd0e62de4e5bd919c00846233e8dd7adca7c1888)  

---

## Layer 0x00 - RarSFX

The entry layer of the executable is just some scripted RAR self-extract archives with commands in the comments. At a glance, it seems the archive contains many files of different types. However, the attackers only used primitive techniques in an attempt to hide commands in seemingly garbage data, and the crucial information can be easily identified.  

<p align="center">
<img src="data/layer0x00/fig-0-0.png"><br>
Fig. 0-0: The commands in a self-sxtract sample.
</p>

---

## Layer 0x01 - VBE

The mentioned RarSFX command points to a Visual Basic script and executes it silently. The script is encoded in `UTF16LE` and is decorated with a bunch of garbage comments. This again can be easily extracted using [a simple script](src/layer0x01/vbe-trim.js).  

<p align="center">
<img src="data/layer0x01/fig-1-0.png"><br>
Fig. 1-0: Trimmed VBE script.
</p>

---

## Layer 0x02 - AutoIt

The previous script points to a PE file and a file in the archive as an argument. The PE file, in this case, is actually an AutoIt interpreter disguised as a Malwarebytes installer. The AutoIt script file fed into the interpreter contains a significant amount of garbage comments, also in the `UTF16LE` encoding. As the comment blocks (`#cs` and `#ce`) and syntax can still be easily identified, a concentrated script can be retrieved using [another simple script](src/layer0x02/autoit-trim.js).  

With the concentrated script, we may now see some interesting function calls and definitions, such as `MainPE` and `_Crypt_DecryptData`. The script also reads an obfuscated `ini` config in the archive, which can be [easily debofuscated](src/layer0x02/ini-trim.js). The script is a full-fledged payload delivery program and contains many functionalities, such as VM detection, payload installation, disabling UAC, etc.  

To deploy the actual malicious payload, the script first reads the `ini` config and retrieves the hex-encoded encrypted data, and then decrypts the data using the built-in Windows cryptography library. A password is predefined in the `ini` config, and the script makes calls to `advapi32.dll` to produce the `MD5` digest of the password as a 128-bit `RC2` key, which decrypts the payload.  

<p align="center">
<img src="data/layer0x02/fig-2-0.png"><br>
Fig. 2-0: Deobfuscated functions for payload decryption in the AutoIt delivery script.
</p>

<p align="center">
<img src="data/layer0x02/fig-2-1.png"><br>
Fig. 2-1: Trimmed config.
</p>

Here's [a script](src/layer0x02/rc2-decrypt.js) I made that decrypts the payload. An [alternative in C](src/layer0x02/rc2-decrypt.c) is also available.

---

## Final Payload - nanocore
At the final stage, both samples I received dropped a nanocore RAT. The files can be found here:  
[`e1d52fa44cdb5622ac262c05ce7e783f5ca3142fe3dce0f1d389a6f03d69d185`](https://www.virustotal.com/gui/file/e1d52fa44cdb5622ac262c05ce7e783f5ca3142fe3dce0f1d389a6f03d69d185)  
[`24439061130ed4fe67e82fa7ed7f0a4129fd837936fa764ba4002ce6459e2853`](https://www.virustotal.com/gui/file/24439061130ed4fe67e82fa7ed7f0a4129fd837936fa764ba4002ce6459e2853)  