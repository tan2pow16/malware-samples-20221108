'use strict';

/*
 * Copyright (c) 2022, Tangent65536.
 *  All rights reserved.
 */

const fs = require('fs');
const path = require('path');

function __main__(args)
{
  if(args.length < 1)
  {
    console.log(`Usage: node ${__filename} <path/to/sample> <charset>`);
    return;
  }

  let encoding = args[1] || 'utf16le';

  let path_in = path.resolve(args[0]);
  let dir_in = path.resolve(args[0], '..');
  let filename = path.basename(path_in);
  
  let content = fs.readFileSync(path_in);

  if(encoding.toLowerCase() === 'utf16le' && content.readUInt16LE(0) === 0xFEFF)
  {
    content = content.subarray(2);
  }

  let lines = content.toString(encoding).split(/\r?\n/g);
  let comment_block_flag = false;
  for(let i = 0 ; i < lines.length ; i++)
  {
    if(comment_block_flag)
    {
      if(lines[i].startsWith('#ce'))
      {
        comment_block_flag = false;
      }
    }
    else
    {
      if(lines[i].startsWith('#cs'))
      {
        comment_block_flag = true;
        continue;
      }

      if(lines[i].startsWith(';'))
      {
        continue;
      }

      console.log(`${lines[i]}\r`);
    }
  }
}

if(require.main === module)
{
  process.on('uncaughtException', function(err) {
    console.error(err);
  });
  
  __main__(process.argv.slice(2));
}
